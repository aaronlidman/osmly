function keyclean(e){return e.replace(/\W/g,"")}function token(e,t){return 2===arguments.length&&(localStorage[keyclean(osmly.settings.writeApi)+e]=t),localStorage[keyclean(osmly.settings.writeApi)+e]}function byId(e){return document.getElementById(e)}function byTag(e){return document.getElementsByTagName(e)}function createE(e){return document.createElement(e)}function createId(e,t){var o=createE(e);return o.setAttribute("id",t),o}function timeAgo(){var e={prefix:"",suffix:" ago",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years"},t=function(t,o){return e[t]&&e[t].replace(/%d/i,Math.abs(Math.round(o)))},o=function(o){if(o){o=o.replace(/\.\d+/,""),o=o.replace(/-/,"/").replace(/-/,"/"),o=o.replace(/T/," ").replace(/Z/," UTC"),o=o.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2"),o=new Date(1e3*o||o);var n=new Date,a=.001*(n.getTime()-o)>>0,i=a/60,s=i/60,l=s/24,r=l/365;return e.prefix+(45>a&&t("seconds",a)||90>a&&t("minute",1)||45>i&&t("minutes",i)||90>i&&t("hour",1)||24>s&&t("hours",s)||42>s&&t("day",1)||30>l&&t("days",l)||45>l&&t("month",1)||365>l&&t("months",l/30)||1.5>r&&t("year",1)||t("years",r))+e.suffix}},n=document.getElementsByClassName("timeago");for(var a in n){var i=n[a];"object"==typeof i&&(i.innerHTML=o(i.getAttribute("title")||i.getAttribute("datetime")))}}function leftToRight(e){$(e).on("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){e.hide(),e.removeClass("fadeLefttoRight")}),e.show(),e.addClass("fadeLefttoRight")}function bigUp(e){$(e).on("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){e.hide(),e.removeClass("fadeInUpBig")}),e.show(),e.addClass("fadeInUpBig")}var settings={title:"",db:"",writeApi:"http://api06.dev.openstreetmap.org",oauth_secret:"Mon0UoBHaO3qvfgwWrMkf4QAPM0O4lITd3JRK4ff",consumerKey:"yx996mtweTxLsaxWNc96R7vpfZHKQdoI9hzJRFwg",readApi:"http://www.overpass-api.de/api/xapi?map?",context:{},origin:[0,0],zoom:2,demo:!0,changesetTags:{created_by:"OSMLY","osmly:version":"1.0.0",imagery_used:"Bing"},renameProperty:{},usePropertyAsTag:[],appendTag:{},featureStyle:{color:"#00FF00",weight:3,opacity:1,clickable:!1},contextStyle:{color:"#FFFF00",fillOpacity:.3,weight:3,opacity:1},users:[],admins:[]};window.osmly=function(){var e={settings:settings};return e.go=function(t){window.location.hash="",$(function(){if("object"==typeof t)for(var o in t)e.settings[o]=t[o];else alert("need some settings");e.map=e.map(),e.ui.go()})},e}(),osmly.auth=function(){var e=osmAuth({oauth_secret:osmly.settings.oauth_secret,oauth_consumer_key:osmly.settings.consumerKey,auto:!1,url:osmly.settings.writeApi,landing:location.protocol+"//"+location.host+"/land.html"});return e.userAllowed=function(){return osmly.settings.users.length?osmly.settings.users.indexOf(token("user"))>-1?!0:osmly.settings.admins.indexOf(token("user"))>-1?!0:!1:!0},e.notAllowed=function(){$("#reusable-modal .modal-content").html("<h3>You are not on the list of allowed users.</h3>"),CSSModal.open("reusable-modal")},e.adminAllowed=function(){return osmly.settings.admins.indexOf(token("user"))>-1?!0:osmly.settings.admins.length?!1:!0},e}(),osmly.map=function(){function e(e,t){$.ajax({url:osmly.settings.readApi+"bbox="+e.join(","),dataType:"xml",success:function(e){t(e)}})}function t(e){for(var t={type:"FeatureCollection",features:[]},o=0;o<e.features.length;o++){var n=e.features[o],a=!1;for(var i in n.properties)i in osmly.settings.context&&osmly.settings.context[i].indexOf(n.properties[i])>-1&&!a&&(a=!0);(a||!Object.keys(osmly.settings.context).length)&&t.features.push(n)}return t}function o(e){n.contextLayer=L.geoJson(e,{style:osmly.settings.contextStyle,onEachFeature:function(e,t){var o="",n="NO NAME, click for tags",a=0,i=Object.keys(e.properties);if(e.properties){for(e.properties.name&&(n=e.properties.name);a<i.length;)o+='<li><span class="k">'+i[a]+"</span>: "+e.properties[i[a]]+"</li>",a++;t.bindPopup(o),t.bindLabel(n)}},pointToLayer:function(e,t){return L.circleMarker(t,{radius:6,opacity:1,fillOpacity:.33})}})}var n=L.map("map",{center:osmly.settings.origin,layers:[new L.BingLayer("Arzdiw4nlOJzRwOz__qailc8NiR31Tt51dN2D7cm57NrnceZnCpgOkmJhNpGoppU")],zoom:osmly.settings.zoom,maxZoom:20,fadeAnimation:!1});return n.on("moveend",function(){var e=n.getCenter().wrap(),t=e.lat.toFixed(4).toString(),o=e.lng.toFixed(4).toString(),a=n.getZoom().toString();osmly.osmlink="http://www.openstreetmap.org/#map="+a+"/"+t+"/"+o}),n.attributionControl.setPrefix(!1),osmly.settings.writeApi.split("dev").length>1&&n.attributionControl.setPrefix("DEV SERVER"),n.osmTiles=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:20,maxNativeZoom:18}),n.context=function(a,i,s){i&&(a=[a[0]-i,a[1]-i,a[2]+i,a[3]+i]),n.hasLayer(n.contextLayer)&&n.removeLayer(n.contextLayer),osmly.ui.notify("getting nearby OSM data"),e(a,function(e){osmly.ui.notify("rendering OSM data"),context=t(osm_geojson.osm2geojson(e)),o(context),n.addLayer(n.contextLayer),s()})},n.toggleLayer=function(e){n.hasLayer(e)?n.removeLayer(e):n.addLayer(e)},n.setFeature=function(e,t,o){n.featureLayer=L.geoJson(e,{style:osmly.settings.featureStyle,onEachFeature:function(o,n){if(t)if("MultiPolygon"==e.geometry.type)for(var a in n._layers)n._layers[a].editing.enable();else n.editing.enable()}}),n.fitBounds(n.featureLayer.getBounds()),o&&(n.featureLayer.addTo(osmly.map),n.featureLayer.bringToFront())},n},osmly.ui=function(){function e(){$("body").append('            <div id="mode">                <div id="demo">Demonstration »</div>                <div id="login">Login with your OSM account »</div>            </div>        '),osmly.settings.writeApi.split("dev").length>1&&$("#login").text("Login with your OSM dev server account »"),$("body").append('            <span id="title"></span>            <ul id="top-bar">                <a href="#instruction-modal">                    <li id="instruction" style="border-left: none;">Instructions</li>                </a>                <li id="overview">Overview</li>                <li id="qa" alt="Quality Assurance">QA</li>                <a href="#user-modal">                    <li id="user"></li>                </a>                <a href="#demo-modal">                    <li id="demo-mode">DEMO MODE</li>                </a>            </ul>            <div id="notify"></div>        '),$("body").append('            <div class="semantic-content" id="demo-modal" style="text-align: center;">                <div class="modal-inner">                    <header id="modal-label">                        <h2>Demo Mode</h2>                    </header>                    <div class="modal-content">                        <span>This is a read-only demo mode, nothing is uploaded or saved in any way.</span><br/><br/>                        <span>Feel free to click everything, edit, etc.. nothing bad can happen.</span><br/>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="instruction-modal">                <div class="modal-inner">                    <header id="modal-label"><h2>Instructions</h2></header>                    <div class="modal-content">                    '+osmly.settings.instructions+'                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="remote-edit-modal">                <div class="modal-inner">                    <div class="modal-content">                        <h2 style="margin-top: 50px; text-align: center;">Loading in JOSM...</h2>                        <h4 style="margin-bottom: 50px; text-align: center;">(don\'t forget to download the surrounding area)</h4>                        <hr/>                        <h4 style="margin-top: 25px;">When you\'re done:</h4>                        <h2 style="text-align: center; margin: 20px 0;">Did you upload the feature via JOSM?</h2>                        <div style="text-align: center; margin-bottom: 25px;">                            <button data-type="no" style="margin-left: 0;">No, not uploaded to OSM</button>                            <button data-type="yes">Yes, uploaded</button>                        </div>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="reusable-modal">                <div class="modal-inner wide800">                    <div class="modal-content">                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="user-modal">                <div class="modal-inner">                    <div class="modal-content">                        <div id="logout" style="text-align: center; margin: 50px 0;">Logout »</div>                        <div id="changeset" style="display: none;">                            <hr style="margin-top: 50px;">                            <h2 style="margin-top: 50px;">Changeset</h2>                            <div id="changeset-form" contenteditable="true"></div>                            <span id="changeset-link"></span>                            <span id="update-change">update</span>                        </div>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>        ')}function t(){return osmly.settings.region?(l.region=L.geoJson(osmly.settings.region,{style:{color:"#fff",fill:!1,clickable:!1,weight:3,opacity:1}}),osmly.map.fitBounds(l.region.getBounds()),l.region.addTo(osmly.map),l.region.bringToFront(),void 0):!1}function o(){$("#demo").on("click",s),$("#login").on("click",i),$("#qa").one("click",osmly.mode.qa),$("#overview").on("click",osmly.mode.overview),$("#update-change").on("click",n),$("#remote-edit-modal").on("click",a),$("#logout").on("click",function(){osmly.auth.logout(),location.reload()})}function n(){osmly.settings.changesetTags.comment=$("#changeset-form").text(),osmly.connect.updateComment(function(){CSSModal.close(),$("#notify").hide()})}function a(){var e=this.getAttribute("data-type");if("yes"==e){var t=osmly.imp.id;this.getAttribute("data-id")&&(t=this.getAttribute("data-id")),osmly.auth.authenticated()?osmly.auth.userAllowed()?osmly.connect.updateItem("submit",{submit:"JOSM"},function(){CSSModal.close(),t==osmly.imp.id?skip():osmly.overview.modalDone()},t):osmly.auth.notAllowed():(CSSModal.close(),osmly.ui.pleaseLogin())}else CSSModal.close()}function i(){l.notify(""),osmly.auth.authenticate(function(){osmly.auth.userAllowed?(l.region&&osmly.map.removeLayer(l.region),$("#login, #demo").fadeOut(250),CSSModal.open("instruction-modal"),osmly.connect.getDetails(),osmly.mode.import()):osmly.auth.notAllowed()})}function s(){l.region&&osmly.map.removeLayer(l.region),$("#login, #demo").fadeOut(250),CSSModal.open("demo-modal"),$("#demo-mode").show(),osmly.mode.import()}var l={};return l.go=function(){e(),document.title=osmly.settings.title,$("#title").html(osmly.settings.title),$("#title, #top-bar").fadeIn(250),osmly.auth.authenticated()?osmly.auth.userAllowed()?(l.setUserDetails(),osmly.mode.import()):(setTimeout(osmly.auth.notAllowed,500),$("#demo").fadeIn(250),t()):($("#login, #demo").fadeIn(250),t()),osmly.settings.demo||$("#demo").fadeOut(250),o()},l.pleaseLogin=function(){$("#reusable-modal .modal-content").html("<h3>Please login. It helps track your changes so other users don't edit the same feature.</h3>"),CSSModal.open("reusable-modal")},l.notify=function(e){""!==e&&(e="<span>"+e+"</span>"),e='<img src="static/loader.gif" />'+e,$("#notify").html(e),$("#notify").show()},l.setUserDetails=function(){$("#user").html="",token("avatar")&&$("#user").append('<img height="25px" src="'+token("avatar")+'"/>'),$("#user").append('<span style="padding-left: 30px;">'+token("user")+"</span>").fadeIn(250),osmly.auth.adminAllowed()&&$("#qa").fadeIn(250)},l}(),osmly.mode=function(){function e(e){t.last=t.now,t.now=e}var t={now:!1,last:!1};return t.set=function(o){return t.now==o?!1:(t.now&&osmly[t.now].stop(),osmly[o].go(),e(o),void 0)},t.import=function(){t.set("import")},t.qa=function(){t.set("qa")},t.overview=function(){t.set("overview")},t.toLast=function(){t.last?t.set(t.last):(osmly[t.now].stop(),t.now=!1)},t}(),osmly.connect=function(){function e(e,t){var o=osmly.settings.db+"&id="+e+"&action=status";$.ajax({url:o,dataType:"json",success:function(e){"ok"==e.status?t():t("skip")}})}function t(e){osmly.ui.notify("creating a new changeset"),osmly.auth.xhr({method:"PUT",path:"/api/0.6/changeset/create",content:o(),options:{header:{"Content-Type":"text/xml"}}},function(t,o){o&&(token(osmly.settings.db+"changeset_id",o),token(osmly.settings.db+"changeset_created",parseInt(new Date/1e3)),e())})}function o(){var e="";for(var t in osmly.settings.changesetTags)e+='<tag k="'+t+'" v="'+osmly.settings.changesetTags[t]+'"/>';return e+='<tag k="osmly:import" v="'+osmly.settings.db.split("?")[1].split("=")[1]+'"/>',"<osm><changeset>"+e+"</changeset></osm>"}function n(e,t){if(e)return console.log("error! try clearing your browser cache"),void 0;var o=t.getElementsByTagName("user")[0];token("user",o.getAttribute("display_name")),o.getElementsByTagName("img")&&token("avatar",o.getElementsByTagName("img")[0].getAttribute("href")),osmly.ui.setUserDetails()}function a(e){return osm_geojson.geojson2osm(e)}var i={};return i.updateItem=function(t,o,n,a){function i(e){e&&n?n():$.ajax({url:s,type:"POST",data:o,dataType:"json",success:function(){n&&n()}})}"object"!=typeof o&&(o={}),a=a||osmly.import.id;var s=osmly.settings.db+"&id="+a+"&action="+t;o.user=token("user"),"submit"==t?e(a,i):i()},i.openChangeset=function(e,o){token(osmly.settings.db+"changeset_id")?!o&&token(osmly.settings.db+"changeset_created")&&token(osmly.settings.db+"changeset_created")-parseInt(new Date/1e3)>-3500?e():(osmly.ui.notify("checking changeset status"),$.ajax({url:osmly.settings.writeApi+"/api/0.6/changeset/"+token(osmly.settings.db+"changeset_id"),dataType:"xml",success:function(o){var n=o.getElementsByTagName("changeset");"true"===n[0].getAttribute("open")?(token(osmly.settings.db+"changeset_created",parseInt(new Date/1e3)),e&&e()):t(e)}})):t(e)},i.updateComment=function(e){function t(){osmly.ui.notify("updating changeset"),osmly.auth.xhr({method:"PUT",path:"/api/0.6/changeset/"+token(osmly.settings.db+"changeset_id"),content:o(),options:{header:{"Content-Type":"text/xml"}}},function(t){t?n():e()})}function n(){i.openChangeset(t,!0)}i.openChangeset(t)},i.getDetails=function(){osmly.auth.xhr({method:"GET",path:"/api/0.6/user/details"},n)},i.editInJosm=function(e){function t(){$.ajax({url:"http://127.0.0.1:8111/import?url="+n,dataType:"xml",error:function(){$("#reusable-modal .modal-content").html("<h3>JOSM doesn't seem to be running. Start JOSM and try again.</h3>"),CSSModal.open("reusable-modal")},success:function(){$("#remote-edit-modal button")[1].setAttribute("data-id",e),CSSModal.open("remote-edit-modal")}})}if(!osmly.auth.authenticated())return osmly.ui.pleaseLogin(),!1;if(osmly.auth.userAllowed()){var o,n=osmly.settings.db+"&id="+e+"&action=remote";e===osmly.import.id?(o=a(osmly.map.featureLayer.toGeoJSON()),i.updateItem("remote",{remote:o},t,e)):$.ajax({url:osmly.settings.db+"&id="+e,dataType:"json",success:function(n){for(var s in osmly.settings.renameProperty){var l=osmly.settings.renameProperty[s];n.properties[l]=n.properties[s]}for(var r in n.properties)-1===osmly.settings.usePropertyAsTag.indexOf(r)&&(n.properties[r]=null);for(var d in osmly.settings.appendTag)n.properties[d]=osmly.settings.appendTag[d];o=a(n),i.updateItem("remote",{remote:o},t,e)}})}else osmly.auth.notAllowed()},i}(),osmly.import=function(){function e(){$("#josm").on("click",m),$("#reset").on("click",c),$("#osmlink").on("click",function(){window.open(osmly.osmlink)}),$("#skip").on("click",l),$("#problem").on("change",d),$("#submit").on("click",r),$("#add-new-tag").on("click",u),$("#tags").on("click",".minus",function(){$("#tags tr").length>1&&this.parentNode.remove()}),$("#osmtiles").on("click",function(){$("#tags").toggle(),$("#action-block").toggle(),osmly.map.toggleLayer(osmly.map.osmTiles),osmly.map.toggleLayer(osmly.map.contextLayer),osmly.map.toggleLayer(osmly.map.featureLayer)})}function t(){$("#skip, #problem, #submit").off(),$("#josm, #reset, #osmlink, #osmtiles").off(),$("#add-new-tag, #tags").off()}function o(){$("body").append('            <div id="tags">                <table>                    <tbody></tbody>                </table>                <span class="k" id="add-new-tag" alt="Add a new tag">+</span>            </div>        '),$("body").append('            <div id="action-block">                <li id="hold-problem" style="margin-left: 0;">                    <select name="problem" id="problem">                        <option value="problem" disabled selected>Problem</option>                    </select>                </li>                <li id="skip">Skip</li>                <li id="submit">Submit</li>            </div>        ');for(var e=$("#problem"),t=0;t<osmly.settings.problems.length;t++)e.append('<option value="'+[t]+'">'+osmly.settings.problems[t]+"</option>");$("body").append('            <ul id="bottom-right">                <li id="reset">reset</li>                <li id="josm">edit in JOSM</li>                <li id="osmtiles">see OSM map</li>                <li id="osmlink" style="border-bottom: none;">open at osm.org</li>            </ul>        '),$("body").append('            <div id="flash">                <div style="position: relative">                    <img class="problem hidden flash" src="static/problem.svg" />                    <img class="right-arrow hidden flash" src="static/right-arrow.svg" />                    <img class="up-arrow hidden flash" src="static/up-arrow.svg" />                </div>            </div>        ')}function n(){$("#tags, #action-block, #bottom-right, #flash").remove(),osmly.map.closePopup(),osmly.map.hasLayer(osmly.map.featureLayer)&&osmly.map.removeLayer(osmly.map.featureLayer),osmly.map.hasLayer(osmly.map.contextLayer)&&osmly.map.removeLayer(osmly.map.contextLayer)}function a(){osmly.map.addLayer(osmly.map.featureLayer),osmly.map.addLayer(osmly.map.contextLayer),$("#notify").hide(),$("#hold-problem, #submit, #bottom-right, #action-block").fadeIn(250),L.isEditable?$("#tags").fadeIn(250):($("#hold-problem, #submit").fadeOut(250),$("#reusable-modal .modal-content").html("<h3>This feature is too complex. <a>Edit it in JOSM?</a></h3>"),CSSModal.open("reusable-modal"))}function i(){var e=L.data.properties;for(var t in e)null!==e[t]&&"null"!==e[t]&&$("#tags tbody").append('<tr><td class="k" spellcheck="false" contenteditable="true">'+t+"</td>"+'<td class="v" spellcheck="false" contenteditable="true">'+e[t]+"</td>"+'<td class="minus">-</td>'+"</tr>")}function s(e){$("#bottom-right, #action-block, #tags").fadeOut(250,function(){e&&e()}),osmly.map.closePopup(),osmly.map.featureLayer&&osmly.map.removeLayer(osmly.map.featureLayer),osmly.map.removeLayer(osmly.map.contextLayer)}function l(){s(),$("#tags tr").remove(),leftToRight($(".right-arrow")),p()}function r(){s(),osmly.auth.authenticated()&&osmly.auth.userAllowed()?(osmly.connect.updateItem("submit"),osmly.connect.openChangeset(k)):($("#tags tr").remove(),p()),bigUp($(".up-arrow"))}function d(){if(s(),osmly.auth.authenticated()&&osmly.auth.userAllowed()){var e=parseInt($("#problem").val())+1;osmly.connect.updateItem("problem",{problem:$("#problem option")[e].text})}$(".problem").show(function(){setTimeout(function(){$(".problem").fadeOut(250)},250)}),$("#problem").val("problem"),$("#tags tr").remove(),p()}function m(){$("#reset").trigger("click"),osmly.connect.editInJosm(L.id)}function c(){$("#tags tr").remove(),s(a),osmly.map.setFeature(L.data,L.isEditable),i()}function u(){$("#tags tbody").append('            <tr>            <td class="k" spellcheck="false" contenteditable="true"></td>            <td class="v" spellcheck="false" contenteditable="true"></td>            <td class="minus">-</td>            </tr>        ')}function p(){osmly.map.hasLayer(osmly.map.featureLayer)&&osmly.map.removeLayer(osmly.map.featureLayer),osmly.ui.notify("getting next item"),$.ajax({url:osmly.settings.db,dataType:"json",success:function(e){e?y(e):g()}})}function y(e){L.data=e,L.id=L.data.properties.id,L.bbox=L.data.properties.bounds,L.isEditable=f(L.data.geometry),osmly.map.setFeature(L.data,L.isEditable),L.prepTags(),L.isEditable?osmly.map.context(L.bbox,.001,function(){i(),a()}):(i(),a())}function g(){$("#notify").hide(),$("#reusable-modal .modal-content").html("<h3>Nothing left, checkout Overview.</h3>"),CSSModal.open("reusable-modal")}function f(e){if("Polygon"==e.type&&e.coordinates.length>1)return!1;if("MultiPolygon"==e.type)for(var t=0,o=e.coordinates.length;o>t;t+=1)if(e.coordinates[t].length>1)return!1;return!0}function h(){for(var e in osmly.settings.renameProperty){var t=osmly.settings.renameProperty[e];L.data.properties[t]=L.data.properties[e]}}function b(){for(var e in L.data.properties)-1===osmly.settings.usePropertyAsTag.indexOf(e)&&(L.data.properties[e]=null)}function v(){for(var e in osmly.settings.appendTag)L.data.properties[e]=osmly.settings.appendTag[e]}function k(){var e=token(osmly.settings.db+"changeset_id");$("#changeset-link").html('<a href="'+osmly.settings.writeApi+"/browse/changeset/"+e+'" target="_blank">Details on osm.org »</a>'),$("#changeset").show();var t=osmly.map.featureLayer.toGeoJSON();t.features[0].properties=osmly.import.tags();var o=osm_geojson.geojson2osm(t,token(osmly.settings.db+"changeset_id"),!0);osmly.ui.notify("uploading to OSM"),osmly.auth.xhr({method:"POST",path:"/api/0.6/changeset/"+e+"/upload",content:o,options:{header:{"Content-Type":"text/xml"}}},w)}function w(e,t){t&&!e||osmly.connect.openChangeset(k,!0),$("#tags tr").remove(),p()}var L={};return L.go=function(){o(),e(),p()},L.stop=function(){t(),n()},L.prepTags=function(){h(),b(),v()},L.tags=function(){for(var e=byId("tags"),t=e.getElementsByTagName("tr"),o={},n=0;n<t.length;n++){var a=t[n].getElementsByTagName("td");""!==a[0].innerHTML&&""!==a[1].innerHTML&&(o[a[0].innerHTML]=a[1].innerHTML)}return o},L}(),osmly.overview=function(){function e(){$("body").append('            <div class="semantic-content" id="markdone-modal">                <div class="modal-inner wide800">                    <div class="modal-content">                        <h2 style="margin: 20px 0; text-align: center;">Are you sure? Please use with caution.</h2>                        <h2 style="margin: 20px 0; text-align: center;"> This will prevent other users from editing this feature.</h2>                        <div style="width: 100%; text-align: center;">                            <button data-type="no" style="margin-left: 0;">No, don\'t mark it as done</button>                            <button data-type="yes">Yes, mark it as done</button>                        </div>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div id="overview_bg"></div>            <div id="overview_block">                <table id="main_table" class="table">                    <thead>                        <tr>                            <th>#</th>                            <th>Name</th>                            <th>Problem</th>                            <th>Uploaded</th>                            <th>User</th>                            <th>Mark as Done</th>                            <th>Edit in JOSM</th>                        </tr>                    </thead>                </table>            </div>            <div id="overview-controls">                <span id="count"></span>                <input type="radio" name="filter" value="everything" id="everything" checked>                    <label for="everything"> everything</label><br>                <input type="radio" name="filter" value="red" id="red">                    <label for="red"> problems (red)</label><br>                <input type="radio" name="filter" value="green" id="green">                    <label for="green"> done (green)</label><br>                <input type="radio" name="filter" value="users" id="users">                    <label for="users"> user: </label>                    <select id="users-select"></select><br>                <input type="radio" name="filter" value="problems" id="problems">                    <label for="problems"> problem: </label>                    <select id="problems-select"></select><br>            </div>        ')}function t(){$("#main_table").on("click",".editjosm",function(){osmly.connect.editInJosm(this.getAttribute("data-id"))}),$("#main_table").on("click",".markdone",function(){osmly.auth.authenticated()?osmly.auth.userAllowed()?($("#markdone-modal button")[1].setAttribute("data-id",this.getAttribute("data-id")),CSSModal.open("markdone-modal")):osmly.auth.notAllowed():osmly.ui.pleaseLogin()}),$("#overview_bg").on("click",osmly.mode.toLast),$("#everything").on("click",c),$("#red").on("click",u),$("#green").on("click",p),$("#users").on("click",function(){y("users-select")}),$("#users-select").on("change",function(){y("users-select")}),$("#problems").on("click",function(){y("problems-select")}),$("#problems-select").on("change",function(){y("problems-select")}),$("#markdone-modal").on("click","button",f)}function o(){$("#main_table").off(),$("#overview_bg").off(),$("#everything").off(),$("#red").off(),$("#green").off(),$("#users").off(),$("#users-select").off(),$("#problems").off(),$("#problems-select").off(),$("#markdone-modal").off()}function n(e){var t=b.data,o=byId("main_table");o.getElementsByTagName("tbody").length&&o.removeChild(o.getElementsByTagName("tbody")[0]);for(var n=createE("tbody"),a=0;a<t.length;a++){for(var i=createE("tr"),s=0;s<t[a].length;s++){var l=createE("td"),r=b.bIndex[s],d=t[a][s];"submit"==r&&""!==d&&(d="&#x2713;"),"name"==r&&(l.style.textAlign="left",l.style.textOverflow="ellipsis",l.style.width="200px",l.whiteSpace="nowrap",l.overflow="hidden"),l.innerHTML=d,i.appendChild(l)}var m=createE("td");""===t[a][b.index.submit]&&(m.innerHTML='<span data-id="'+t[a][b.index.id]+'" class="markdone">done?</span>'),i.appendChild(m);var c=createE("td");""===t[a][b.index.submit]&&(c.innerHTML='<span data-id="'+t[a][b.index.id]+'" class="editjosm">JOSM?</span>'),i.appendChild(c),""!==t[a][b.index.submit]?i.setAttribute("class","success"):""!==t[a][b.index.problem]&&i.setAttribute("class","error"),n.appendChild(i),o.appendChild(n)}$("#notify").hide(),g(),e&&e()}function a(e){$.ajax({url:osmly.settings.db+"&overview",cache:!1,dataType:"json",success:function(t){b.data=t,b.rawData=t,e&&e()}})}function i(e){osmly.ui.notify("Loading..."),a(function(){n(e),r(),d()})}function s(e){for(var t=b.rawData,o=Object.keys(e).length,n=[],a=0;a<t.length;a++){var i=[];for(var s in e)"object"==typeof e[s]?-1!==e[s].indexOf(t[a][b.index[s]])&&i.push(!0):t[a][b.index[s]]==e[s]&&i.push(!0);i.length===o&&n.push(t[a])}b.data=n}function l(e){for(var t=b.rawData,o=[],n=0;n<t.length;n++)t[n][b.index[e]]&&-1===o.indexOf(t[n][b.index[e]])&&o.push(t[n][b.index[e]]);return o}function r(){for(var e=l("problem"),t="",o=0;o<e.length;o++)t+='<option value="problem:'+e[o]+'">'+e[o]+"</option>";byId("problems-select").innerHTML=t}function d(){for(var e=l("user"),t="",o=0;o<e.length;o++)t+='<option value="user:'+e[o]+'">'+e[o]+"</option>";byId("users-select").innerHTML=t}function m(e){for(var t=byId("overview-controls").getElementsByTagName("input"),o=0;o<t.length;o++)"radio"===t[o].type&&(t[o].checked=t[o].value==e?!0:!1)}function c(){b.data=b.rawData,n()}function u(){s({problem:l("problem"),submit:""}),m("red"),n()}function p(){s({submit:l("submit")}),m("green"),n()}function y(e){var t,o=byId(e),a={};o.options[o.selectedIndex]?(t=o.options[o.selectedIndex].value,t=t.split(":"),a[t[0]]=t[1],"problem"==t[0]&&(a.submit="")):a={problem:"-1"},s(a),n(),m(e.split("-")[0])}function g(){byId("count").innerHTML=b.data.length===b.rawData.length?b.data.length:b.data.length.toString()+"<span>/"+b.rawData.length+"</span>"}function f(){"yes"==this.getAttribute("data-type")?osmly.connect.updateItem("submit",{submit:"Mark as Done"},function(){osmly.overview.modalDone(function(){CSSModal.close()})},this.getAttribute("data-id")):CSSModal.close()}var h={},b={index:{id:0,name:1,problem:2,submit:3,user:4},bIndex:["id","name","problem","submit","user"]};return h.go=function(){e(),$("#overview_bg, #overview-controls, #overview_block").fadeIn(250),i(),t()},h.stop=function(){b.data=null,b.rawData=null,$("#markdone, #overview_block, #overview_bg, #overview-controls").remove(),o()},h.modalDone=function(e){m("everything"),i(e)},h}(),osmly.qa=function(){function e(){byId("qa").innerHTML="Leave QA",byId("qa").style.backgroundColor="black",byId("qa").style.color="white",$("#qa").one("click",osmly.mode.import);var e=byTag("body")[0],t=createId("div","qa-block");e.appendChild(t);var o=createId("div","report");t.appendChild(o);var n=createId("div","toggleLayers");t.appendChild(n),n.innerHTML="[w] see original feature";var a=createId("div","qa-skip");t.appendChild(a),a.innerHTML="[s] skip";var i=createId("div","confirm");t.appendChild(i),i.innerHTML="confirm",$("body").append('            <ul id="bottom-right">                <li id="osmtiles">see OSM map</li>                <li id="osmlink" style="border-bottom: none;">open at osm.org</li>            </ul>        ')}function t(){$("#toggleLayers").on("click",p),$("#qa-skip").one("click",s),$("#confirm").on("click",u),$("#osmlink").on("click",function(){window.open(osmly.osmlink)}),$("#osmtiles").on("click",function(){osmly.map.toggleLayer(osmly.map.osmTiles)}),$("body").on("keydown",function(e){87===e.keyCode&&p(),83===e.keyCode&&s()})}function o(){$("#toggleLayers, #qa-skip, #confirm").off(),$("body").off("keydown"),$("#osmlink, #osmtiles").off()}function n(){var e=byId("qa");e.innerHTML="QA",e.style.backgroundColor="white",e.style.color="black",$("#qa").one("click",osmly.mode.qa),$("#qa-block, #bottom-right").remove()}function a(e){$.ajax({url:osmly.settings.db+"&qa",cache:!1,dataType:"json",success:function(t){return t?(g={id:t[0],geo:JSON.parse(t[1]),problem:t[2],submit:t[3],user:t[4],time:t[5]},g.geo.properties.name&&(g.name=g.geo.properties.name),e&&e(),void 0):l()}})}function i(){var e=createE("table"),t=byId("report");t.getElementsByTagName("table").length&&t.removeChild(t.childNodes[0]);var o=createE("tbody");for(var n in g){var a=createE("tr");"id"==n&&(a.innerHTML="<td>id</td><td>"+g.id+"</td>"),"user"==n&&(a.innerHTML="<td>who</td><td>"+g.user+"</td>"),"time"==n&&(a.innerHTML='<td>when</td><td class="timeago" title="'+g.time+'">'+g.time+"</td>"),"problem"==n&&""!==g.problem&&(a.innerHTML='<td>problem</td><td class="k">'+g.problem+"</td>"),"submit"==n&&1!=g.submit&&(a.innerHTML="<td>via</td><td>"+g.submit+"</td>"),"name"==n&&(a.innerHTML="<td>name</td><td>"+g.name+"</td>"),""!==a.innerHTML&&o.appendChild(a)}e.appendChild(o),t.appendChild(e),timeAgo()}function s(){r(),a(function(){i(),c(),d()})}function l(){$("#reusable-modal .modal-content").html("<h3>Nothing to check right now</h3>"),CSSModal.open("reusable-modal")}function r(){o(),osmly.map.hasLayer(osmly.map.contextLayer)&&osmly.map.removeLayer(osmly.map.contextLayer),osmly.map.hasLayer(osmly.map.featureLayer)&&osmly.map.removeLayer(osmly.map.featureLayer),byId("toggleLayers").innerHTML="[w] see original feature",$("#qa-block, #bottom-right").hide()
}function d(){var e=g.geo.properties.bounds;osmly.map.fitBounds([[e[1],e[0]],[e[3],e[2]]]),osmly.map.context(e,.002,m)}function m(){osmly.map.removeLayer(osmly.map.featureLayer),$("#qa-block, #bottom-right").fadeIn(250),$("#notify").hide(),t()}function c(){osmly.map.setFeature(g.geo,!1,!0)}function u(){osmly.connect.updateItem("confirm",!1,!1,g.id),s()}function p(){osmly.map.hasLayer(osmly.map.featureLayer)?(byId("toggleLayers").innerHTML="[w] see original feature",osmly.map.removeLayer(osmly.map.featureLayer),osmly.map.addLayer(osmly.map.contextLayer)):(byId("toggleLayers").innerHTML="[w] see OSM data",osmly.map.removeLayer(osmly.map.contextLayer),osmly.map.addLayer(osmly.map.featureLayer))}var y={live:!1},g={};return y.go=function(){e(),s()},y.stop=function(){r(),n()},y}();
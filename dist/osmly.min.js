function keyclean(e){return e.replace(/\W/g,"")}function token(e,t){return 2===arguments.length&&(localStorage[keyclean(osmly.settings.writeApi)+e]=t),localStorage[keyclean(osmly.settings.writeApi)+e]}function byId(e){return document.getElementById(e)}function byTag(e){return document.getElementsByTagName(e)}function createE(e){return document.createElement(e)}function createId(e,t){var o=createE(e);return o.setAttribute("id",t),o}function timeAgo(){var e={prefix:"",suffix:" ago",seconds:"less than a minute",minute:"about a minute",minutes:"%d minutes",hour:"about an hour",hours:"about %d hours",day:"a day",days:"%d days",month:"about a month",months:"%d months",year:"about a year",years:"%d years"},t=function(t,o){return e[t]&&e[t].replace(/%d/i,Math.abs(Math.round(o)))},o=function(o){if(o){o=o.replace(/\.\d+/,""),o=o.replace(/-/,"/").replace(/-/,"/"),o=o.replace(/T/," ").replace(/Z/," UTC"),o=o.replace(/([\+\-]\d\d)\:?(\d\d)/," $1$2"),o=new Date(1e3*o||o);var n=new Date,a=.001*(n.getTime()-o)>>0,i=a/60,s=i/60,r=s/24,l=r/365;return e.prefix+(45>a&&t("seconds",a)||90>a&&t("minute",1)||45>i&&t("minutes",i)||90>i&&t("hour",1)||24>s&&t("hours",s)||42>s&&t("day",1)||30>r&&t("days",r)||45>r&&t("month",1)||365>r&&t("months",r/30)||1.5>l&&t("year",1)||t("years",l))+e.suffix}},n=document.getElementsByClassName("timeago");for(var a in n){var i=n[a];"object"==typeof i&&(i.innerHTML=o(i.getAttribute("title")||i.getAttribute("datetime")))}}function leftToRight(e){$(e).on("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){e.hide(),e.removeClass("fadeLefttoRight")}),e.show(),e.addClass("fadeLefttoRight")}function bigUp(e){$(e).on("animationend webkitAnimationEnd MSAnimationEnd oAnimationEnd",function(){e.hide(),e.removeClass("fadeInUpBig")}),e.show(),e.addClass("fadeInUpBig")}var settings={title:"",db:"",writeApi:"http://api06.dev.openstreetmap.org",oauth_secret:"Mon0UoBHaO3qvfgwWrMkf4QAPM0O4lITd3JRK4ff",consumerKey:"yx996mtweTxLsaxWNc96R7vpfZHKQdoI9hzJRFwg",readApi:"http://www.overpass-api.de/api/xapi?map?",context:{},origin:[0,0],zoom:2,demo:!0,changesetTags:{created_by:"OSMLY","osmly:version":"1.1.0",imagery_used:"Bing"},renameProperty:{},usePropertyAsTag:[],appendTag:{},featureStyle:{color:"#00FF00",weight:3,opacity:1,clickable:!1,dashArray:"5, 10"},contextStyle:{color:"#FFFF00",fillOpacity:.3,weight:3,opacity:1},users:[],admins:[],discardTags:["created_by","odbl","odbl:note","tiger:upload_uuid","tiger:tlid","tiger:source","tiger:separated","geobase:datasetName","geobase:uuid","sub_sea:type","KSJ2:ADS","KSJ2:ARE","KSJ2:AdminArea","KSJ2:COP_label","KSJ2:DFD","KSJ2:INT","KSJ2:INT_label","KSJ2:LOC","KSJ2:LPN","KSJ2:OPC","KSJ2:PubFacAdmin","KSJ2:RAC","KSJ2:RAC_label","KSJ2:RIC","KSJ2:RIN","KSJ2:WSC","KSJ2:coordinate","KSJ2:curve_id","KSJ2:curve_type","KSJ2:filename","KSJ2:lake_id","KSJ2:lat","KSJ2:long","KSJ2:river_id","yh:LINE_NAME","yh:LINE_NUM","yh:STRUCTURE","yh:TOTYUMONO","yh:TYPE","yh:WIDTH_RANK","SK53_bulk:load"]};window.osmly=function(){var e={settings:settings};return e.go=function(t){window.location.hash="",$(function(){if("object"==typeof t)for(var o in t)if("Object"!=Object.prototype.toString.call(t[o]).slice(8,-1)||"contextStyle"!==o&&"featureStyle"!==o&&"changesetTags"!==o)e.settings[o]=t[o];else for(var n in t[o])e.settings[o][n]=t[o][n];else alert("need some settings");e.auth=e.auth(),e.map=e.map(),e.ui.go()})},e}(),osmly.auth=function(){var e=osmly.settings.writeApi;1===e.split("dev").length&&(e="http://www.openstreetmap.org");var t=osmAuth({oauth_secret:osmly.settings.oauth_secret,oauth_consumer_key:osmly.settings.consumerKey,auto:!1,url:e,landing:location.protocol+"//"+location.host+"/land.html"});return t.userAllowed=function(){return osmly.settings.users.length?osmly.settings.users.indexOf(token("user"))>-1?!0:osmly.settings.admins.indexOf(token("user"))>-1?!0:!1:!0},t.notAllowed=function(){$("#reusable-modal .modal-content").html("<h3>You are not on the list of allowed users.</h3>"),CSSModal.open("reusable-modal")},t.adminAllowed=function(){return osmly.settings.admins.indexOf(token("user"))>-1?!0:osmly.settings.admins.length?!1:!0},t},osmly.map=function(){function e(e,t){$.ajax({url:osmly.settings.readApi+"bbox="+e.join(","),dataType:"xml",success:function(e){n.osmContext=e,t(e)}})}function t(e){for(var t={type:"FeatureCollection",features:[]},o=0;o<e.features.length;o++){var n=e.features[o],a=!1;for(var i in n.properties)i in osmly.settings.context&&osmly.settings.context[i].indexOf(n.properties[i])>-1&&!a&&(a=!0);(a||!Object.keys(osmly.settings.context).length)&&t.features.push(n)}return t}function o(e){var t=0;n.contextLayer=L.geoJson(e,{style:osmly.settings.contextStyle,onEachFeature:function(e,o){var n="",a="NO NAME, click for tags",i=0,s=Object.keys(e.properties);if(e.properties){for(o.bindPopup(n),e.properties.name&&(a=e.properties.name);i<s.length;)1===s[i].split("osm_").length&&(n+='<li><span class="k">'+s[i]+"</span>: "+e.properties[s[i]]+"</li>"),i++;"Point"==e.geometry.type&&"import"==osmly.mode.now&&(n+='<li class="merge"                            data-layer-id="'+t+"\"                            data-tags='"+JSON.stringify(e.properties)+'\'                            style="                            margin-top: 10px;                            text-align: center;                            padding: 10px 0;                            border: 1px solid #aaa;                            background-color: #eee;                            cursor: pointer;                            ">Merge with import data</li>'),e.properties._id=t,o._popup._content=n,o.bindLabel(a),t++}},pointToLayer:function(e,t){return L.circleMarker(t,{radius:6,opacity:1,fillOpacity:.33})}})}var n=L.map("map",{center:osmly.settings.origin,layers:[new L.BingLayer("Arzdiw4nlOJzRwOz__qailc8NiR31Tt51dN2D7cm57NrnceZnCpgOkmJhNpGoppU")],zoom:osmly.settings.zoom,fadeAnimation:!1});return n.on("moveend",function(){var e=n.getCenter().wrap(),t=e.lat.toFixed(4).toString(),o=e.lng.toFixed(4).toString(),a=n.getZoom().toString();osmly.osmlink="http://www.openstreetmap.org/#map="+a+"/"+t+"/"+o}),n.attributionControl.setPrefix(!1),osmly.settings.writeApi.split("dev").length>1&&n.attributionControl.setPrefix("DEV SERVER"),n.osmTiles=L.tileLayer("http://{s}.tile.osm.org/{z}/{x}/{y}.png",{maxZoom:20,maxNativeZoom:18}),n.context=function(a,i,s){i&&(a=[a[0]-i,a[1]-i,a[2]+i,a[3]+i]),n.hasLayer(n.contextLayer)&&n.removeLayer(n.contextLayer),osmly.ui.notify("getting nearby OSM data"),e(a,function(e){osmly.ui.notify("rendering OSM data"),context=t(osm_geojson.osm2geojson(e,!0)),o(context),n.addLayer(n.contextLayer),s()})},n.toggleLayer=function(e){n.hasLayer(e)?n.removeLayer(e):n.addLayer(e)},n.setFeature=function(e,t,o){n.featureLayer=L.geoJson(e,{style:osmly.settings.featureStyle,onEachFeature:function(o,n){if(t)if("MultiPolygon"==e.geometry.type)for(var a in n._layers)n._layers[a].editing.enable();else n.editing.enable()}}),n.fitBounds(n.featureLayer.getBounds()),o&&(n.featureLayer.addTo(osmly.map),n.featureLayer.bringToFront())},n},osmly.ui=function(){function e(){$("body").append('            <div id="mode">                <div id="demo">Demonstration »</div>                <div id="login">Login with your OSM account »</div>            </div>        '),osmly.settings.writeApi.split("dev").length>1&&$("#login").text("Login with your OSM dev server account »"),$("body").append('            <span id="title"></span>            <ul id="top-bar">                <a href="#instruction-modal">                    <li id="instruction" style="border-left: none;">Instructions</li>                </a>                <li id="overview">Overview</li>                <li id="qa" alt="Quality Assurance">QA</li>                <a href="#user-modal">                    <li id="user"></li>                </a>                <a href="#demo-modal">                    <li id="demo-mode">DEMO MODE</li>                </a>            </ul>            <div id="notify"></div>        '),$("body").append('            <div class="semantic-content" id="demo-modal" style="text-align: center;">                <div class="modal-inner">                    <header id="modal-label">                        <h2>Demo Mode</h2>                    </header>                    <div class="modal-content">                        <span>This is a read-only demo mode, nothing is uploaded or saved in any way.</span><br/><br/>                        <span>Feel free to click everything, edit, etc.. nothing bad can happen.</span><br/>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="instruction-modal">                <div class="modal-inner">                    <header id="modal-label"><h2>Instructions</h2></header>                    <div class="modal-content">                    '+osmly.settings.instructions+'                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="remote-edit-modal">                <div class="modal-inner">                    <div class="modal-content">                        <h2 style="margin-top: 50px; text-align: center;">Loading in JOSM...</h2>                        <h4 style="margin-bottom: 50px; text-align: center;">(don\'t forget to download the surrounding area)</h4>                        <hr/>                        <h4 style="margin-top: 25px;">When you\'re done:</h4>                        <h2 style="text-align: center; margin: 20px 0;">Did you upload the feature via JOSM?</h2>                        <div style="text-align: center; margin-bottom: 25px;">                            <button data-type="no" style="margin-left: 0;">No, not uploaded to OSM</button>                            <button data-type="yes">Yes, uploaded</button>                        </div>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="reusable-modal">                <div class="modal-inner wide800">                    <header id="modal-label"></header>                    <div class="modal-content">                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div class="semantic-content" id="user-modal">                <div class="modal-inner">                    <div class="modal-content">                        <div id="logout" style="text-align: center; margin: 50px 0;">Logout »</div>                        <div id="changeset" style="display: none;">                            <hr style="margin-top: 50px;">                            <h2 style="margin-top: 50px;">Changeset</h2>                            <div id="changeset-form" contenteditable="true"></div>                            <span id="changeset-link"></span>                            <span id="update-change">update</span>                        </div>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>        ')}function t(){return osmly.settings.region?(r.region=L.geoJson(osmly.settings.region,{style:{color:"#fff",fill:!1,clickable:!1,weight:3,opacity:1}}),osmly.map.fitBounds(r.region.getBounds()),r.region.addTo(osmly.map),void r.region.bringToFront()):!1}function o(){$("#demo").on("click",s),$("#login").on("click",i),$("#qa").one("click",osmly.mode.qa),$("#overview").on("click",osmly.mode.overview),$("#update-change").on("click",n),$("#remote-edit-modal").on("click","button",a),$("#logout").on("click",function(){osmly.auth.logout(),location.reload()})}function n(){osmly.settings.changesetTags.comment=$("#changeset-form").text(),osmly.connect.updateComment(function(){CSSModal.close(),$("#notify").hide()})}function a(){if(console.log(this),"yes"==this.getAttribute("data-type")){var e=this.getAttribute("data-id");osmly.auth.authenticated()?osmly.auth.userAllowed()?osmly.connect.updateItem("submit",{submit:"JOSM"},function(){CSSModal.close(),"import"==osmly.mode.now?osmly.import.skip():osmly.overview.modalDone()},e):osmly.auth.notAllowed():(CSSModal.close(),osmly.ui.pleaseLogin())}else CSSModal.close()}function i(){r.notify(""),osmly.auth.authenticate(function(e){return e?void console.log("auth error"):void(osmly.auth.userAllowed?(r.region&&osmly.map.removeLayer(r.region),$("#login, #demo").fadeOut(250),CSSModal.open("instruction-modal"),osmly.connect.getDetails(),osmly.mode.import()):osmly.auth.notAllowed())})}function s(){r.region&&osmly.map.removeLayer(r.region),$("#login, #demo").fadeOut(250),CSSModal.open("demo-modal"),$("#demo-mode").show(),osmly.mode.import()}var r={};return r.go=function(){e(),document.title=osmly.settings.title,$("#title").html(osmly.settings.title),$("#title, #top-bar").fadeIn(250),osmly.auth.authenticated()?osmly.auth.userAllowed()?(r.setUserDetails(),osmly.mode.import()):(setTimeout(osmly.auth.notAllowed,500),$("#demo").fadeIn(250),t()):($("#login, #demo").fadeIn(250),t()),osmly.settings.demo||$("#demo").fadeOut(250),o()},r.pleaseLogin=function(){$("#reusable-modal .modal-content").html("<h3>Please login. It helps track your changes so other users don't edit the same feature.</h3>"),CSSModal.open("reusable-modal")},r.notify=function(e){""!==e&&(e="<span>"+e+"</span>"),e='<img src="http://osmly.com/dist/loader.gif" />'+e,$("#notify").html(e),$("#notify").show()},r.setUserDetails=function(){$("#user").html="",token("avatar")&&$("#user").append('<img height="25px" src="'+token("avatar")+'"/>'),$("#user").append('<span style="padding-left: 30px;">'+token("user")+"</span>").fadeIn(250),osmly.auth.adminAllowed()&&$("#qa").fadeIn(250)},r}(),osmly.mode=function(){function e(e){t.last=t.now,t.now=e}var t={now:!1,last:!1};return t.set=function(o){return t.now==o?!1:(t.now&&osmly[t.now].stop(),osmly[o].go(),void e(o))},t.import=function(){t.set("import")},t.qa=function(){t.set("qa")},t.overview=function(){t.set("overview")},t.toLast=function(){t.last?t.set(t.last):(osmly[t.now].stop(),t.now=!1)},t}(),osmly.connect=function(){function e(e,t){var o=osmly.settings.db+"&id="+e+"&action=status";$.ajax({url:o,dataType:"json",success:function(e){"ok"==e.status?t():t("skip")}})}function t(e){osmly.ui.notify("creating a new changeset"),osmly.auth.xhr({method:"PUT",path:"/api/0.6/changeset/create",content:o(),options:{header:{"Content-Type":"text/xml"}}},function(t,o){o&&(token(osmly.settings.db+"changeset_id",o),token(osmly.settings.db+"changeset_created",parseInt(new Date/1e3)),e())})}function o(){var e="";for(var t in osmly.settings.changesetTags)e+='<tag k="'+t+'" v="'+osmly.settings.changesetTags[t]+'"/>';return e+='<tag k="osmly:import" v="'+osmly.settings.db.split("?")[1].split("=")[1]+'"/>',"<osm><changeset>"+e+"</changeset></osm>"}function n(e,t){if(e)return void console.log("error! try clearing your browser cache");var o=t.getElementsByTagName("user")[0];token("user",o.getAttribute("display_name")),o.getElementsByTagName("img")&&token("avatar",o.getElementsByTagName("img")[0].getAttribute("href")),osmly.ui.setUserDetails()}function a(e){return osm_geojson.geojson2osm(e)}var i={};return i.updateItem=function(t,o,n,a){function i(e){e&&n?n():$.ajax({url:s,type:"POST",data:o,dataType:"json",success:function(){n&&n()}})}"object"!=typeof o&&(o={}),a=a||osmly.import.id;var s=osmly.settings.db+"&id="+a+"&action="+t;o.user=token("user"),"submit"==t?e(a,i):i()},i.openChangeset=function(e,o){token(osmly.settings.db+"changeset_id")?!o&&token(osmly.settings.db+"changeset_created")&&token(osmly.settings.db+"changeset_created")-parseInt(new Date/1e3)>-3500?e():(osmly.ui.notify("checking changeset status"),$.ajax({url:osmly.settings.writeApi+"/api/0.6/changeset/"+token(osmly.settings.db+"changeset_id"),dataType:"xml",success:function(o){var n=o.getElementsByTagName("changeset");"true"===n[0].getAttribute("open")?(token(osmly.settings.db+"changeset_created",parseInt(new Date/1e3)),e&&e()):t(e)}})):t(e)},i.updateComment=function(e){function t(){osmly.ui.notify("updating changeset"),osmly.auth.xhr({method:"PUT",path:"/api/0.6/changeset/"+token(osmly.settings.db+"changeset_id"),content:o(),options:{header:{"Content-Type":"text/xml"}}},function(t){t?n():e()})}function n(){i.openChangeset(t,!0)}i.openChangeset(t)},i.getDetails=function(){osmly.auth.xhr({method:"GET",path:"/api/0.6/user/details"},n)},i.editInJosm=function(e){function t(){$.ajax({url:"http://127.0.0.1:8111/import?url="+n,dataType:"xml",error:function(){$("#reusable-modal .modal-content").html("<h3>JOSM doesn't seem to be running. Start JOSM and try again.</h3>"),CSSModal.open("reusable-modal")},success:function(){$("#remote-edit-modal button")[1].setAttribute("data-id",e),CSSModal.open("remote-edit-modal")}})}if(!osmly.auth.authenticated())return osmly.ui.pleaseLogin(),!1;if(osmly.auth.userAllowed()){var o,n=osmly.settings.db+"&id="+e+"&action=remote";e===osmly.import.id?(o=a(osmly.map.featureLayer.toGeoJSON()),i.updateItem("remote",{remote:o},t,e)):$.ajax({url:osmly.settings.db+"&id="+e,dataType:"json",success:function(n){for(var s in osmly.settings.renameProperty){var r=osmly.settings.renameProperty[s];n.properties[r]=n.properties[s]}for(var l in n.properties)-1===osmly.settings.usePropertyAsTag.indexOf(l)&&(n.properties[l]=null);for(var d in osmly.settings.appendTag)n.properties[d]=osmly.settings.appendTag[d];o=a(n),i.updateItem("remote",{remote:o},t,e)}})}else osmly.auth.notAllowed()},i}(),osmly.import=function(){function e(){$("#josm").on("click",d),$("#reset").on("click",m),$("#osmlink").on("click",function(){window.open(osmly.osmlink)}),$("#skip").on("click",A.skip),$("#problem").on("change",l),$("#submit").on("click",r),$("#add-new-tag").on("click",c),$("#tags").on("click",".minus",function(){$("#tags tr").length>1&&this.parentNode.remove()}),$("#osmtiles").on("click",function(){$("#tags").toggle(),$("#action-block").toggle(),osmly.map.toggleLayer(osmly.map.osmTiles),osmly.map.toggleLayer(osmly.map.contextLayer),osmly.map.toggleLayer(osmly.map.featureLayer)}),$(document).on("click",".merge",function(){A.mergeTags=JSON.parse(this.getAttribute("data-tags")),A.mergeLayer=this.getAttribute("data-layer-id");var e=L(A.mergeTags);e?x(e):S()}),$("#reusable-modal").on("click","button",function(){$('[data-tag="'+this.getAttribute("data-tag")+'"]').removeAttr("style"),$('[data-tag="'+this.getAttribute("data-tag")+'"]').removeAttr("data-selected"),this.setAttribute("style","background: #7EEE7A"),this.setAttribute("data-selected","true")}),$("#reusable-modal").on("click","#merge",function(){var e=$("[data-selected]");if(e.length==this.getAttribute("data-count"))for(var t=0;t<e.length;t++)A.mergeTags[e[t].getAttribute("data-tag")]=e[t].textContent;S()})}function t(){$("#skip, #problem, #submit").off(),$("#josm, #reset, #osmlink, #osmtiles").off(),$("#add-new-tag, #tags").off()}function o(){var e=$("body");e.append('            <div id="tags">                <table>                    <tbody></tbody>                </table>                <span class="k" id="add-new-tag" alt="Add a new tag">+</span>            </div>        '),e.append('            <div id="action-block">                <li id="hold-problem" style="margin-left: 0;">                    <select name="problem" id="problem">                        <option value="problem" disabled selected>Problem</option>                    </select>                </li>                <li id="skip">Skip</li>                <li id="submit">Submit</li>            </div>        ');for(var t=$("#problem"),o=0;o<osmly.settings.problems.length;o++)t.append('<option value="'+[o]+'">'+osmly.settings.problems[o]+"</option>");e.append('            <ul id="bottom-right">                <li id="reset">reset</li>                <li id="josm">edit in JOSM</li>                <li id="osmtiles">see OSM map</li>                <li id="osmlink" style="border-bottom: none;">open at osm.org</li>            </ul>        '),e.append('            <div id="flash">                <div style="position: relative">                    <img class="problem hidden flash" src="http://osmly.com/dist/problem.svg" />                    <img class="right-arrow hidden flash" src="http://osmly.com/dist/right-arrow.svg" />                    <img class="up-arrow hidden flash" src="http://osmly.com/dist/up-arrow.svg" />                </div>            </div>        ')}function n(){$("#tags, #action-block, #bottom-right, #flash").remove(),osmly.map.closePopup(),osmly.map.hasLayer(osmly.map.featureLayer)&&osmly.map.removeLayer(osmly.map.featureLayer),osmly.map.hasLayer(osmly.map.contextLayer)&&osmly.map.removeLayer(osmly.map.contextLayer)}function a(){osmly.map.addLayer(osmly.map.featureLayer),osmly.map.addLayer(osmly.map.contextLayer),$("#notify").hide(),$("#hold-problem, #submit, #bottom-right, #action-block").fadeIn(200),A.isEditable?$("#tags").fadeIn(200):($("#hold-problem, #submit").hide(),$("#reusable-modal .modal-content").html("<h3>This feature is too complex. <a>Edit it in JOSM?</a></h3>"),CSSModal.open("reusable-modal"))}function i(e){$("#tags tr").remove();for(var t in e)null!==e[t]&&"null"!==e[t]&&$("#tags tbody").append('<tr><td class="k" spellcheck="false" contenteditable="true">'+t+'</td><td class="v" spellcheck="false" contenteditable="true">'+e[t]+'</td><td class="minus">-</td></tr>')}function s(e){$("#bottom-right, #action-block, #tags").hide(),e&&e(),osmly.map.closePopup(),osmly.map.featureLayer&&osmly.map.removeLayer(osmly.map.featureLayer),osmly.map.removeLayer(osmly.map.contextLayer)}function r(){s(),osmly.auth.authenticated()&&osmly.auth.userAllowed()?(osmly.connect.updateItem("submit"),osmly.connect.openChangeset(v)):($("#tags tr").remove(),u()),bigUp($(".up-arrow"))}function l(){if(s(),osmly.auth.authenticated()&&osmly.auth.userAllowed()){var e=parseInt($("#problem").val())+1;osmly.connect.updateItem("problem",{problem:$("#problem option")[e].text})}$(".problem").show(function(){setTimeout(function(){$(".problem").fadeOut(250)},250)}),$("#problem").val("problem"),$("#tags tr").remove(),u()}function d(){$("#reset").trigger("click"),osmly.connect.editInJosm(A.id)}function m(){$("#tags tr").remove(),s(),osmly.map.setFeature(A.data,A.isEditable),i(A.data.properties),A.deleted=[],a()}function c(){$("#tags tbody").append('            <tr>            <td class="k" spellcheck="false" contenteditable="true"></td>            <td class="v" spellcheck="false" contenteditable="true"></td>            <td class="minus">-</td>            </tr>        ')}function u(){osmly.map.hasLayer(osmly.map.featureLayer)&&osmly.map.removeLayer(osmly.map.featureLayer),osmly.ui.notify("getting next item"),$.ajax({url:osmly.settings.db,dataType:"json",success:function(e){e?p(e):y()}})}function p(e){A.data=e,A.id=A.data.properties.id,A.bbox=A.data.properties.bounds,A.isEditable=g(A.data.geometry),osmly.map.setFeature(A.data,A.isEditable),A.prepTags(),A.isEditable?osmly.map.context(A.bbox,.001,function(){i(A.data.properties),a()}):(i(A.data.properties),a())}function y(){$("#notify").hide(),$("#reusable-modal .modal-content").html("<h3>Nothing left, checkout Overview.</h3>"),CSSModal.open("reusable-modal")}function g(e){if("Polygon"==e.type&&e.coordinates.length>1)return!1;if("MultiPolygon"==e.type)for(var t=0,o=e.coordinates.length;o>t;t+=1)if(e.coordinates[t].length>1)return!1;return!0}function f(){for(var e in osmly.settings.renameProperty){var t=osmly.settings.renameProperty[e];A.data.properties[t]=A.data.properties[e]}}function h(){for(var e in A.data.properties)-1===osmly.settings.usePropertyAsTag.indexOf(e)&&(A.data.properties[e]=null)}function b(){for(var e in osmly.settings.appendTag)A.data.properties[e]=osmly.settings.appendTag[e]}function v(){var e=token(osmly.settings.db+"changeset_id");$("#changeset-link").html('<a href="'+osmly.settings.writeApi+"/browse/changeset/"+e+'" target="_blank">Details on osm.org »</a>'),$("#changeset").show();var t=osmly.map.featureLayer.toGeoJSON();t.features[0].properties=k();var o=osm_geojson.geojson2osm(t,token(osmly.settings.db+"changeset_id"));o=o.split('<osm version="0.6" generator="github.com/aaronlidman/osm-and-geojson">').join('<osmChange version="0.6" generator="OSMLY"><create>'),o=o.split("</osm>").join(""),o+="</create>",o+=T(),o+="</osmChange>",osmly.ui.notify("uploading to OSM"),osmly.auth.xhr({method:"POST",path:"/api/0.6/changeset/"+e+"/upload",content:o,options:{header:{"Content-Type":"text/xml"}}},w)}function k(){var e=osmly.import.tags();for(var t in e)for(var o=0;o<osmly.settings.discardTags.length;o++)osmly.settings.discardTags[o]==t&&delete e[t];return e}function w(e,t){t&&!e||osmly.connect.openChangeset(v,!0),$("#tags tr").remove(),u()}function L(e){var t={},o=0,n=osmly.import.tags();for(var a in e)n[a]&&n[a]!=e[a]&&(t[a]=e[a],o++);return o?t:!1}function x(e){$("#reusable-modal #modal-label").html("<h2>Tag Conflict</h2>");var t="",o=osmly.import.tags(),n=0;for(var a in e)t+='<div class="conflict">\''+a+'\' is <button class="eee" data-tag="'+a+'" data-source="import">'+o[a]+'</button> or <button class="eee" data-tag="'+a+'" data-source="osm">'+e[a]+"</button> ?</div>",n++;t+='<span id="merge" data-count="'+n+'" style="cursor: pointer; font-weight: bold;">Merge</span>',$("#reusable-modal .modal-content").html(t),CSSModal.open("reusable-modal")}function S(){var e={};A.deleted||(A.deleted=[]),A.deleted.push(A.mergeTags.osm_id);for(var t in A.mergeTags)1===t.split("osm_").length&&(e[t]=A.mergeTags[t]);i(e),CSSModal.close(),osmly.map.eachLayer(function(e){"undefined"!=typeof e.feature&&"undefined"!=typeof e.feature.properties&&"undefined"!=typeof e.feature.properties._id&&e.feature.properties._id==parseInt(A.mergeLayer)&&osmly.map.removeLayer(e)})}function T(){if(!("deleted"in A&&A.deleted.length))return"";if(osmly.settings.writeApi.split("dev").length>1)return"";var e='<delete if-unused="true">',t=new XMLSerializer;for(var o in A.deleted){var n=osmly.map.osmContext.getElementById(A.deleted[o]);n.setAttribute("changeset",token(osmly.settings.db+"changeset_id")),e+=t.serializeToString(n)}return e=e.split("	").join(""),e=e.split("\n").join(""),e+"</delete>"}var A={};return A.go=function(){o(),e(),u()},A.stop=function(){t(),n()},A.skip=function(){A.deleted=[],s(),leftToRight($(".right-arrow")),u()},A.prepTags=function(){f(),h(),b()},A.tags=function(){for(var e=byId("tags"),t=e.getElementsByTagName("tr"),o={},n=0;n<t.length;n++){var a=t[n].getElementsByTagName("td");""!==a[0].innerHTML&&""!==a[1].innerHTML&&(o[a[0].innerHTML]=a[1].innerHTML)}return o},A.bindContextNodes=function(){var e=osmly.map.contextLayer._map._layers;for(var t in e)t=e[t],t._icon&&t.options.opacity&&1===t.options.opacity&&(console.log("bound"),t.on("mouseover",function(){console.log("sticky door")}))},A}(),osmly.overview=function(){function e(){$("body").append('            <div class="semantic-content" id="markdone-modal">                <div class="modal-inner wide800">                    <div class="modal-content">                        <h2 style="margin: 20px 0; text-align: center;">Are you sure? Please use with caution.</h2>                        <h2 style="margin: 20px 0; text-align: center;"> This will prevent other users from editing this feature.</h2>                        <div style="width: 100%; text-align: center;">                            <button data-type="no" style="margin-left: 0;">No, don\'t mark it as done</button>                            <button data-type="yes">Yes, mark it as done</button>                        </div>                    </div>                </div>                <a href="#!" class="modal-close" title="Close this modal" data-close="Close" data-dismiss="modal"></a>            </div>            <div id="overview_bg"></div>            <div id="overview_block">                <table id="main_table" class="table">                    <thead>                        <tr>                            <th>#</th>                            <th>Problem</th>                            <th>Uploaded</th>                            <th>User</th>                            <th>Mark as Done</th>                            <th>Edit in JOSM</th>                        </tr>                    </thead>                </table>            </div>            <div id="overview-controls">                <span id="count"></span>                <input type="radio" name="filter" value="everything" id="everything" checked>                    <label for="everything"> everything</label><br>                <input type="radio" name="filter" value="red" id="red">                    <label for="red"> problems (red)</label><br>                <input type="radio" name="filter" value="green" id="green">                    <label for="green"> done (green)</label><br>                <input type="radio" name="filter" value="users" id="users">                    <label for="users"> user: </label>                    <select id="users-select"></select><br>                <input type="radio" name="filter" value="problems" id="problems">                    <label for="problems"> problem: </label>                    <select id="problems-select"></select><br>            </div>        ')}function t(){$("#main_table").on("click",".editjosm",function(){osmly.connect.editInJosm(this.getAttribute("data-id"))}),$("#main_table").on("click",".markdone",function(){osmly.auth.authenticated()?osmly.auth.userAllowed()?($("#markdone-modal button")[1].setAttribute("data-id",this.getAttribute("data-id")),CSSModal.open("markdone-modal")):osmly.auth.notAllowed():osmly.ui.pleaseLogin()}),$("#overview_bg").on("click",osmly.mode.toLast),$("#everything").on("click",c),$("#red").on("click",u),$("#green").on("click",p),$("#users").on("click",function(){y("users-select")}),$("#users-select").on("change",function(){y("users-select")}),$("#problems").on("click",function(){y("problems-select")}),$("#problems-select").on("change",function(){y("problems-select")}),$("#markdone-modal").on("click","button",f)}function o(){$("#main_table").off(),$("#overview_bg").off(),$("#everything").off(),$("#red").off(),$("#green").off(),$("#users").off(),$("#users-select").off(),$("#problems").off(),$("#problems-select").off(),$("#markdone-modal").off()}function n(e){var t=b.data,o=byId("main_table");o.getElementsByTagName("tbody").length&&o.removeChild(o.getElementsByTagName("tbody")[0]);for(var n=createE("tbody"),a=0;a<t.length;a++){var i=createE("tr");for(var s in t[a]){var r=createE("td"),l=t[a][s];"submit"==s&&""!==l&&(l="&#x2713;"),"name"==s&&(r.style.textAlign="left",r.style.textOverflow="ellipsis",r.style.width="200px",r.whiteSpace="nowrap",r.overflow="hidden"),r.innerHTML=l,i.appendChild(r)}var d=createE("td");""===t[a].submit&&(d.innerHTML='<span data-id="'+t[a].id+'" class="markdone">done?</span>'),i.appendChild(d);var m=createE("td");""===t[a].submit&&(m.innerHTML='<span data-id="'+t[a].id+'" class="editjosm">JOSM?</span>'),i.appendChild(m),""!==t[a].submit?i.setAttribute("class","success"):""!==t[a].problem&&i.setAttribute("class","error"),n.appendChild(i),o.appendChild(n)}$("#notify").hide(),g(),e&&e()}function a(e){$.ajax({url:osmly.settings.db+"&overview",cache:!1,dataType:"json",success:function(t){b.data=t,b.rawData=t,e&&e()}})}function i(e){osmly.ui.notify("Loading..."),a(function(){n(e),l(),d()})}function s(e){for(var t=b.rawData,o=Object.keys(e).length,n=[],a=0;a<t.length;a++){var i=[];for(var s in e)"object"==typeof e[s]?-1!==e[s].indexOf(t[a][s])&&i.push(!0):t[a][s]==e[s]&&i.push(!0);i.length===o&&n.push(t[a])}b.data=n}function r(e){for(var t=b.rawData,o=[],n=0;n<t.length;n++)t[n][e]&&-1===o.indexOf(t[n][e])&&o.push(t[n][e]);
return o}function l(){for(var e=r("problem"),t="",o=0;o<e.length;o++)t+='<option value="problem:'+e[o]+'">'+e[o]+"</option>";byId("problems-select").innerHTML=t}function d(){for(var e=r("user"),t="",o=0;o<e.length;o++)t+='<option value="user:'+e[o]+'">'+e[o]+"</option>";byId("users-select").innerHTML=t}function m(e){for(var t=byId("overview-controls").getElementsByTagName("input"),o=0;o<t.length;o++)"radio"===t[o].type&&(t[o].checked=t[o].value==e?!0:!1)}function c(){b.data=b.rawData,n()}function u(){s({problem:r("problem"),submit:""}),m("red"),n()}function p(){s({submit:r("submit")}),m("green"),n()}function y(e){var t,o=byId(e),a={};o.options[o.selectedIndex]?(t=o.options[o.selectedIndex].value,t=t.split(":"),a[t[0]]=t[1],"problem"==t[0]&&(a.submit="")):a={problem:"-1"},s(a),n(),m(e.split("-")[0])}function g(){byId("count").innerHTML=b.data.length===b.rawData.length?b.data.length:b.data.length.toString()+"<span>/"+b.rawData.length+"</span>"}function f(){"yes"==this.getAttribute("data-type")?osmly.connect.updateItem("submit",{submit:"Mark as Done"},function(){osmly.overview.modalDone(function(){CSSModal.close()})},this.getAttribute("data-id")):CSSModal.close()}var h={},b={};return h.go=function(){e(),$("#overview_bg, #overview-controls, #overview_block").fadeIn(250),i(),t()},h.stop=function(){b.data=null,b.rawData=null,$("#markdone, #overview_block, #overview_bg, #overview-controls").remove(),o()},h.modalDone=function(e){m("everything"),i(e)},h}(),osmly.qa=function(){function e(){byId("qa").innerHTML="Leave QA",byId("qa").style.backgroundColor="black",byId("qa").style.color="white",$("#qa").one("click",osmly.mode.import);var e=byTag("body")[0],t=createId("div","qa-block");e.appendChild(t);var o=createId("div","report");t.appendChild(o);var n=createId("div","toggleLayers");t.appendChild(n),n.innerHTML="[w] see original feature";var a=createId("div","qa-skip");t.appendChild(a),a.innerHTML="[s] skip";var i=createId("div","confirm");t.appendChild(i),i.innerHTML="confirm",$("body").append('            <ul id="bottom-right">                <li id="osmtiles">see OSM map</li>                <li id="osmlink" style="border-bottom: none;">open at osm.org</li>            </ul>        ')}function t(){$("#toggleLayers").on("click",p),$("#qa-skip").one("click",s),$("#confirm").on("click",u),$("#osmlink").on("click",function(){window.open(osmly.osmlink)}),$("#osmtiles").on("click",function(){osmly.map.toggleLayer(osmly.map.osmTiles)}),$("body").on("keydown",function(e){87===e.keyCode&&p(),83===e.keyCode&&s()})}function o(){$("#toggleLayers, #qa-skip, #confirm").off(),$("body").off("keydown"),$("#osmlink, #osmtiles").off()}function n(){var e=byId("qa");e.innerHTML="QA",e.style.backgroundColor="white",e.style.color="black",$("#qa").one("click",osmly.mode.qa),$("#qa-block, #bottom-right").remove()}function a(e){$.ajax({url:osmly.settings.db+"&qa",cache:!1,dataType:"json",success:function(t){return t?(g={id:t[0],geo:JSON.parse(t[1]),problem:t[2],submit:t[3],user:t[4],time:t[5]},g.geo.properties.name&&(g.name=g.geo.properties.name),void(e&&e())):r()}})}function i(){var e=createE("table"),t=byId("report");t.getElementsByTagName("table").length&&t.removeChild(t.childNodes[0]);var o=createE("tbody");for(var n in g){var a=createE("tr");"id"==n&&(a.innerHTML="<td>id</td><td>"+g.id+"</td>"),"user"==n&&(a.innerHTML="<td>who</td><td>"+g.user+"</td>"),"time"==n&&(a.innerHTML='<td>when</td><td class="timeago" title="'+g.time+'">'+g.time+"</td>"),"problem"==n&&""!==g.problem&&(a.innerHTML='<td>problem</td><td class="k">'+g.problem+"</td>"),"submit"==n&&1!=g.submit&&(a.innerHTML="<td>via</td><td>"+g.submit+"</td>"),"name"==n&&(a.innerHTML="<td>name</td><td>"+g.name+"</td>"),""!==a.innerHTML&&o.appendChild(a)}e.appendChild(o),t.appendChild(e),timeAgo()}function s(){l(),a(function(){i(),c(),d()})}function r(){$("#reusable-modal .modal-content").html("<h3>Nothing to check right now</h3>"),CSSModal.open("reusable-modal")}function l(){o(),osmly.map.hasLayer(osmly.map.contextLayer)&&osmly.map.removeLayer(osmly.map.contextLayer),osmly.map.hasLayer(osmly.map.featureLayer)&&osmly.map.removeLayer(osmly.map.featureLayer),byId("toggleLayers").innerHTML="[w] see original feature",$("#qa-block, #bottom-right").hide()}function d(){var e=g.geo.properties.bounds;osmly.map.fitBounds([[e[1],e[0]],[e[3],e[2]]]),osmly.map.context(e,.002,m)}function m(){osmly.map.removeLayer(osmly.map.featureLayer),$("#qa-block, #bottom-right").fadeIn(250),$("#notify").hide(),t()}function c(){osmly.map.setFeature(g.geo,!1,!0)}function u(){osmly.connect.updateItem("confirm",!1,!1,g.id),s()}function p(){osmly.map.hasLayer(osmly.map.featureLayer)?(byId("toggleLayers").innerHTML="[w] see original feature",osmly.map.removeLayer(osmly.map.featureLayer),osmly.map.addLayer(osmly.map.contextLayer)):(byId("toggleLayers").innerHTML="[w] see OSM data",osmly.map.removeLayer(osmly.map.contextLayer),osmly.map.addLayer(osmly.map.featureLayer))}var y={live:!1},g={};return y.go=function(){e(),s()},y.stop=function(){l(),n()},y}();